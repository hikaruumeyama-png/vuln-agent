# Google Chat通知 セットアップガイド

脆弱性検出時にGoogle Chatで担当者に通知する機能の設定手順です。

---

## 概要

```
┌─────────────────────────────────────────────────────────────────┐
│                    セットアップの流れ                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Step 1: Chat API 有効化                       （1分）            │
│     ↓                                                            │
│  Step 2: Chat Bot の設定                       （5分）            │
│     ↓                                                            │
│  Step 3: スペースにBotを追加                    （2分）            │
│     ↓                                                            │
│  Step 4: スペースIDを取得                       （1分）            │
│     ↓                                                            │
│  Step 5: 環境変数を設定                         （1分）            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Step 1: Chat API の有効化

### 1.1 APIライブラリにアクセス

```
https://console.cloud.google.com/apis/library/chat.googleapis.com
```

### 1.2 有効化

「**有効にする**」ボタンをクリック

---

## Step 2: Chat Bot の設定

### 2.1 Google Chat API 設定画面にアクセス

```
https://console.cloud.google.com/apis/api/chat.googleapis.com/hangouts-chat
```

### 2.2 「構成」タブで以下を設定

| 項目 | 値 |
|------|-----|
| **アプリ名** | `脆弱性管理Bot` |
| **アバターURL** | （任意）https://example.com/bot-icon.png |
| **説明** | `脆弱性通知を送信するBot` |

### 2.3 機能を設定

| 項目 | 設定 |
|------|------|
| **スペースとグループの会話でアプリを有効にする** | ✅ オン |
| **1:1 でのメッセージの受信** | ✅ オン（オプション） |

### 2.4 接続設定

| 項目 | 設定 |
|------|------|
| **アプリのURL** | 空欄のまま（サービスアカウント認証を使用） |

### 2.5 公開設定

| 項目 | 設定 |
|------|------|
| **このChatアプリを特定のユーザーとグループで利用可能にする** | ✅ オン |
| **ユーザーまたはグループを追加** | 通知を受け取るメンバー |

「**保存**」をクリック

---

## Step 3: スペースにBotを追加

### 3.1 Google Chat を開く

```
https://chat.google.com
```

### 3.2 通知用スペースを作成または選択

1. 左サイドバーの「スペース」横の「**+**」をクリック
2. 「**スペースを作成**」を選択
3. 以下を入力:

| 項目 | 値 |
|------|-----|
| スペース名 | `脆弱性アラート` |
| 説明 | `脆弱性情報の通知スペース` |

4. 「**作成**」をクリック

### 3.3 Botをスペースに追加

1. スペースを開く
2. スペース名をクリック → 「**アプリと統合**」
3. 「**アプリを追加**」をクリック
4. 「**脆弱性管理Bot**」を検索して選択
5. 「**追加**」をクリック

---

## Step 4: スペースIDを取得

### 4.1 スペースのURLを確認

スペースを開いた状態でブラウザのURLを確認:

```
https://chat.google.com/room/AAAA_BBBBB
                              ^^^^^^^^^^
                              これがスペースID
```

### 4.2 スペースID形式

環境変数に設定する形式:

```
spaces/AAAA_BBBBB
```

> **例**: URLが `https://chat.google.com/room/AAAAabcd1234` の場合、
> スペースIDは `spaces/AAAAabcd1234`

---

## Step 5: 環境変数を設定

### 5.1 `.env` ファイルを編集

```bash
cd /path/to/vuln-agent-engine
nano agent/.env
```

以下を追加:

```bash
DEFAULT_CHAT_SPACE_ID=spaces/AAAA_BBBBB
```

### 5.2 再デプロイ

```bash
./deploy.sh
```

---

## Step 6: 動作確認

### 6.1 接続確認

```bash
./test_agent.sh "Chat接続を確認して"
```

期待される応答:
```
Google Chatへの接続に成功しました。
スペース名: 脆弱性アラート
```

### 6.2 テストメッセージ送信

```bash
./test_agent.sh "Chatにテストメッセージを送って"
```

---

## カード形式の通知例

エージェントが脆弱性を検出すると、以下のようなカードが送信されます:

```
┌──────────────────────────────────────────────────┐
│  🛡️ CVE-2024-12345                               │
│  リモートコード実行の脆弱性                        │
├──────────────────────────────────────────────────┤
│  概要                                             │
│  重大度: 緊急                                      │
│  CVSSスコア: 9.8                                  │
│  対応期限: 2024年01月15日                          │
├──────────────────────────────────────────────────┤
│  📋 影響を受けるシステム                           │
│  • 基幹システム                                    │
│  • 顧客管理システム                                │
├──────────────────────────────────────────────────┤
│  👤 担当者                                        │
│  • tanaka@example.com                            │
├──────────────────────────────────────────────────┤
│  [🔍 NVDで詳細確認]                               │
└──────────────────────────────────────────────────┘
```

---

## トラブルシューティング

### エラー: "Request had insufficient authentication scopes"

**原因**: サービスアカウントにChat権限がない

**解決**:
1. Google Cloud Console → IAM
2. サービスアカウントに「Chat Bots」ロールを追加

---

### エラー: "Bot is not a member of the space"

**原因**: BotがスペースにからサマリーにChat Botを追加していない

**解決**: Step 3.3 の手順でBotをスペースに追加

---

### エラー: "Space not found"

**原因**: スペースIDが間違っている

**解決**: Step 4 の手順でスペースIDを再確認

---

## メンション機能について

担当者にメンションするには、担当者がスペースのメンバーである必要があります。

```python
# 担当者にメンションする例
send_vulnerability_alert(
    vulnerability_id="CVE-2024-12345",
    title="リモートコード実行の脆弱性",
    severity="緊急",
    affected_systems=["基幹システム"],
    owners=["tanaka@example.com"]  # この人にメンションが飛ぶ
)
```

---

## 複数スペースへの通知

チームごとに別々のスペースに通知することも可能です:

```python
# インフラチーム用スペース
send_vulnerability_alert(
    ...,
    space_id="spaces/infra_team_space"
)

# 開発チーム用スペース
send_vulnerability_alert(
    ...,
    space_id="spaces/dev_team_space"
)
```
